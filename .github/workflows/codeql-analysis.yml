name: "CodeQL - C# (.NET Framework 4.7.2) - build selected projects (CodeQL v3)"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  codeql:
    name: CodeQL analysis (build selected .csproj)
    runs-on: windows-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: '1'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL (v3)
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
          config-file: .github/codeql/codeql-config.yml

      - name: Download nuget.exe
        shell: powershell
        run: |
          $out = "nuget.exe"
          Invoke-WebRequest -Uri "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe" -OutFile $out
          Write-Host "nuget.exe downloaded to $PWD\$out"
          # do not call invalid nuget subcommands here

      - name: Locate MSBuild (vswhere fallback to PATH) - diagnostic
        id: find-msbuild
        shell: powershell
        run: |
          Write-Host "PWD: $PWD"
          Get-ChildItem -Force | Select-Object -First 200 | Format-Table -AutoSize
          $msbuildPath = $null
          $pf86 = ${env:ProgramFiles(x86)}
          if (-not $pf86 -or -not (Test-Path $pf86)) {
            if ($env:ProgramFiles -and (Test-Path $env:ProgramFiles)) { $pf86 = $env:ProgramFiles }
            elseif ($env:ProgramW6432 -and (Test-Path $env:ProgramW6432)) { $pf86 = $env:ProgramW6432 }
          }
          if ($pf86) { $vswhere = Join-Path $pf86 "Microsoft Visual Studio\Installer\vswhere.exe" } else { $vswhere = $null }
          if ($vswhere -and (Test-Path $vswhere)) {
            $installPath = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath -nologo 2>$null
            if ($installPath) {
              $candidate1 = Join-Path $installPath "MSBuild\Current\Bin\MSBuild.exe"
              $candidate2 = Join-Path $installPath "MSBuild\15.0\Bin\MSBuild.exe"
              if (Test-Path $candidate1) { $msbuildPath = $candidate1 }
              elseif (Test-Path $candidate2) { $msbuildPath = $candidate2 }
            }
          }
          if (-not $msbuildPath) { $msbuildPath = "msbuild" }
          try { & $msbuildPath /version } catch { Write-Warning "Could not execute $msbuildPath /version" }
          Write-Host "Using MSBuild: $msbuildPath"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "msbuild=$msbuildPath"

      - name: Restore & Build solution (preferred) - diagnostic
        shell: powershell
        env:
          MSBUILD_PATH: ${{ steps.find-msbuild.outputs.msbuild }}
        run: |
          Write-Host "Searching for solution files..."
          $solutions = Get-ChildItem -Path (Get-Location) -Filter *.sln -Recurse -File -Depth 3 | Select-Object -First 10
          if ($solutions.Count -eq 0) {
            Write-Host "No .sln files found in repo root (within depth). Falling back to per-project build (not recommended)."
            exit 1
          }

          $slnPath = $solutions[0].FullName
          Write-Host "Using solution: $slnPath"

          if (-not (Test-Path ".\nuget.exe")) {
            Write-Error "nuget.exe not found in workspace. Make sure Download nuget.exe step ran successfully."
            exit 1
          }

          Write-Host "Restoring NuGet packages for solution (detailed output)..."
          & .\nuget.exe restore $slnPath -Verbosity detailed
          if ($LASTEXITCODE -ne 0) {
            Write-Error "nuget restore failed for solution with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

          $msbuild = $env:MSBUILD_PATH
          if (-not $msbuild) { $msbuild = "msbuild" }

          Write-Host "Building solution with MSBuild: $msbuild"
          & $msbuild $slnPath /p:Configuration=Debug /p:Platform="Any CPU" /m
          if ($LASTEXITCODE -ne 0) {
            Write-Error "MSBuild failed for solution with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

          Write-Host "Solution build succeeded."

      - name: Perform CodeQL analysis (v3)
        uses: github/codeql-action/analyze@v3
        with:
          category: "security"